name: CI  # ğŸ‘‹ Nom du workflow (onglet "Actions")

on:
  push:                      # ğŸš€ Lance la CI sur chaque push...
    branches: [ main ]
  pull_request:              # ğŸ” ...et sur chaque Pull Request
    branches: [ main ]

jobs:
  tests:                     # ğŸ§ª Job unique: tests unitaires Spark
    runs-on: ubuntu-latest   # ğŸ§ Runner GitHub (Ubuntu)
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]  # ğŸ Versions Python testÃ©es en parallÃ¨le

    steps:
      # 1) RÃ©cupÃ©rer le code du repo
      - name: ğŸšš Checkout repository
        uses: actions/checkout@v4          # ğŸ“¦ Clone le dÃ©pÃ´t dans le runner

      # 2) Installer Python (version de la matrice)
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5      # ğŸ”§ Installe la version de Python demandÃ©e
        with:
          python-version: ${{ matrix.python-version }}

      # 3) Installer Java 11 (obligatoire pour PySpark)
      - name: â˜• Set up Java 11 (required by Spark)
        uses: actions/setup-java@v4        # ğŸ”§ Installe Java via Temurin (OpenJDK)
        with:
          distribution: temurin            # ğŸ“¦ Distribution OpenJDK
          java-version: "11"               # âœ… Compatible PySpark 3.5.x

      # 4) Installer Poetry (gestionnaire dâ€™env & deps)
      - name: ğŸ“¦ Install Poetry
        uses: abatilo/actions-poetry@v3    # ğŸ”§ Action officielle Poetry
        with:
          poetry-version: "1.8.3"          # ğŸ§­ Version stable recommandÃ©e

      # 5) Configurer lâ€™environnement virtuel Poetry
      - name: ğŸ§­ Configure Poetry virtualenv
        run: |
          poetry config virtualenvs.create true       # âœ… CrÃ©e un venv dÃ©diÃ©
          poetry config virtualenvs.in-project true   # ğŸ“ Place le venv dans .venv/ (chemin prÃ©visible)

      # 6) Cache du venv + cache Poetry (accÃ©lÃ¨re les runs)
      - name: ğŸ§  Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |                                     # ğŸ“‚ RÃ©pertoires mis en cache
            .venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}  # ğŸ”‘ ClÃ© basÃ©e sur le lockfile
          restore-keys: |
            ${{ runner.os }}-poetry-                 # â™»ï¸ Fallback si la clÃ© exacte nâ€™existe pas

      # 7) Installer les dÃ©pendances (prod + dev)
      - name: ğŸ› ï¸ Install dependencies
        run: poetry install --no-interaction         # ğŸ“¥ Installe pyspark, pytest, ruff, etc.

      # 8) Lint + format (avec Ruff, remplace Black + isort)
      - name: ğŸ” Run Ruff checks
        run: |
          poetry run ruff check .           # ğŸ”¬ Lint + conventions + imports
          poetry run ruff format --check .  # ğŸ¨ VÃ©rifie le formatage type Black
          poetry run ruff check --fix .     # ğŸ› ï¸ Corrige automatiquement les erreurs (si possible)

      # 9) Lancer les tests unitaires (unittest)
      - name: ğŸ§ª Run unit tests (unittest)
        env:
          PYSPARK_PYTHON: ${{ github.workspace }}/.venv/bin/python  # ğŸ§  Force PySpark Ã  utiliser le Python du venv Poetry
          SPARK_LOCAL_IP: 127.0.0.1                                  # ğŸ–§ Ã‰vite le warning "loopback address"
        run: |
          poetry run python -m unittest discover -s tests -v         # ğŸ” ExÃ©cute tous les tests "test*_ut.py"
